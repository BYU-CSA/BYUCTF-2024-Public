#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

__attribute__((constructor)) void flush_buf() {
    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);
}

int main(int argc, char* argv[]) {
    puts("Welcome to Level 1!");
    puts("Enter your MIPS shellcode below. The password to level 2 is in /ctf/pwd_next.txt");
    
    // create RWE segment to store code
    void* code = mmap(0, 0x1000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    memset(code, 0xff, 0x1000);

    // read shellcode
    char buf[36];
    printf("Shellcode> ");

    int r = read(0, buf, 32); // read does not terminate on null bytes or newlines
    if (r <= 0) {
        printf("read error\n");
        return 1;
    }


    // RUN CHECKS ON SHELLCODE
    

    // add shellcode to mess up registers
    char mess_registers[108] = {0xff,0xff,0x1f,0x24,0xff,0xff,0x02,0x24,0xff,0xff,0x03,0x24,0xff,0xff,0x04,0x24,0xff,0xff,0x05,0x24,0xff,0xff,0x06,0x24,0xff,0xff,0x07,0x24,0xff,0xff,0x08,0x24,0xff,0xff,0x09,0x24,0xff,0xff,0x0a,0x24,0xff,0xff,0x0b,0x24,0xff,0xff,0x0c,0x24,0xff,0xff,0x0d,0x24,0xff,0xff,0x0e,0x24,0xff,0xff,0x0f,0x24,0xff,0xff,0x18,0x24,0xff,0xff,0x19,0x24,0xff,0xff,0x10,0x24,0xff,0xff,0x11,0x24,0xff,0xff,0x12,0x24,0xff,0xff,0x13,0x24,0xff,0xff,0x14,0x24,0xff,0xff,0x15,0x24,0xff,0xff,0x16,0x24,0xff,0xff,0x17,0x24,0xff,0xff,0x1e,0x24,0xff,0xff,0x1c,0x24};


    // copy shellcode to RWE segment
    memcpy(code, mess_registers, sizeof(mess_registers));
    memcpy(code + sizeof(mess_registers), buf, r);

    // execute shellcode
    ((void (*)())code)();

    return 0;
}